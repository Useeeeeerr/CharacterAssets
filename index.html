<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI 이미지 일괄 변환기</title>
    <!-- ZIP 생성 및 다운로드용 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { background-color: #121212; color: #eee; font-family: sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .box { background: #1e1e1e; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #333; }
        h2 { border-bottom: 2px solid #7c4dff; padding-bottom: 5px; margin-top: 0; color: #b388ff; }
        
        /* 입력창 디자인 */
        input, select, button { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #555; background: #333; color: white; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; border: none; width: auto; min-width: 100px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* 버튼 색상 */
        .btn-blue { background: #3d5afe; } 
        .btn-red { background: #f44336; }
        .btn-green { background: #00e676; color: black; }
        .btn-icon { width: 30px; min-width: 30px; padding: 5px; background: #d32f2f; }

        /* 프리셋 리스트 */
        .preset-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; background: #252525; padding: 5px; border-radius: 4px; }
        .tag-input { flex: 2; }

        /* 결과물 그리드 */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .card { background: #2c2c2c; padding: 10px; border-radius: 8px; }
        .card img { width: 100%; height: 200px; object-fit: cover; display: block; border-radius: 4px; margin-bottom: 5px; }
        .log { margin-top: 10px; color: #00e676; font-size: 0.9rem; min-height: 20px; }

        /* 스위치 등 */
        .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #aaa; margin-top: 5px;}
        input[type="checkbox"] { width: auto; }
    </style>
</head>
<body>

    <h1>AI 표정/자세 변경 툴</h1>

    <!-- 1. 설정 -->
    <div class="box">
        <h2>1. 설정 및 원본</h2>
        
        <label>사용할 API</label>
        <select id="apiSelect">
            <option value="novelai">Novel AI (이미지 생성)</option>
            <option value="nanobanana">NanoBanana (프롬프트 템플릿 테스트)</option>
        </select>

        <label>API Key (브라우저에 자동 저장됨)</label>
        <input type="password" id="apiKey" placeholder="API Key 입력" onchange="saveData()">

        <div class="checkbox-row">
            <input type="checkbox" id="proxyMode" checked> 
            <label for="proxyMode">웹 호환 모드 (깃허브 등에서 API 오류날 때 체크 - 프록시 사용)</label>
        </div>

        <label>공통/기본 프롬프트 (메타데이터)</label>
        <input type="text" id="basePrompt" placeholder="예: masterpiece, best quality, 1girl..." onchange="saveData()">

        <label>원본 이미지 선택</label>
        <input type="file" id="fileInput" accept="image/*" onchange="loadFile()">
        <img id="preview" style="max-height: 100px; margin-top: 10px; display: none;">
    </div>

    <!-- 2. 프리셋 -->
    <div class="box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>2. 표정 프리셋 (<span id="count">0</span>/100)</h2>
            <button class="btn-green" onclick="addPreset()">+ 추가</button>
        </div>
        <div id="presetContainer" style="max-height: 300px; overflow-y: auto;">
            <!-- 프리셋들이 여기 들어감 -->
        </div>
    </div>

    <!-- 3. 실행 -->
    <div class="box" style="text-align: center;">
        <button id="startBtn" class="btn-blue" onclick="startRun()">일괄 생성 시작 (12초 간격)</button>
        <button id="stopBtn" class="btn-red" onclick="stopRun()" disabled>중단</button>
        <br>
        <button class="btn-green" style="margin-top: 15px;" onclick="dlZip()">전체 ZIP 다운로드</button>
        <div id="log" class="log">대기 중...</div>
    </div>

    <!-- 4. 결과 -->
    <div class="grid" id="resultGrid"></div>

<script>
    // == 전역 변수 ==
    let presets = [];
    let imgBase64 = null;
    let isRun = false;
    let stopFlag = false;
    let results = {}; // { id: base64Data }

    // == 시작 시 로드 ==
    window.onload = function() {
        if(localStorage.getItem("apiKey")) document.getElementById("apiKey").value = localStorage.getItem("apiKey");
        if(localStorage.getItem("basePrompt")) document.getElementById("basePrompt").value = localStorage.getItem("basePrompt");
        if(localStorage.getItem("presets")) {
            presets = JSON.parse(localStorage.getItem("presets"));
        } else {
            // 기본 예시
            presets = [
                { id: 1, name: "기쁨", tag: "smile, happy" },
                { id: 2, name: "슬픔", tag: "sad, crying" }
            ];
        }
        renderPresets();
    };

    function saveData() {
        localStorage.setItem("apiKey", document.getElementById("apiKey").value);
        localStorage.setItem("basePrompt", document.getElementById("basePrompt").value);
        localStorage.setItem("presets", JSON.stringify(presets));
    }

    // == 이미지 읽기 ==
    function loadFile() {
        const f = document.getElementById("fileInput").files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            imgBase64 = e.target.result;
            document.getElementById("preview").src = imgBase64;
            document.getElementById("preview").style.display = 'block';
        };
        r.readAsDataURL(f);
    }

    // == 프리셋 UI ==
    function renderPresets() {
        const el = document.getElementById("presetContainer");
        el.innerHTML = "";
        document.getElementById("count").innerText = presets.length;

        presets.forEach((p, i) => {
            const row = document.createElement("div");
            row.className = "preset-row";
            row.innerHTML = `
                <div style="width:30px; text-align:center; color:#777;">${i+1}</div>
                <input type="text" value="${p.name}" placeholder="이름 (예: 기쁨)" oninput="updateP(${p.id}, 'name', this.value)">
                <input type="text" class="tag-input" value="${p.tag}" placeholder="태그 (예: smile)" oninput="updateP(${p.id}, 'tag', this.value)">
                <button class="btn-icon" onclick="delP(${p.id})">X</button>
            `;
            el.appendChild(row);
        });
    }

    function addPreset() {
        if(presets.length >= 100) return alert("최대 100개입니다.");
        presets.push({ id: Date.now(), name: "", tag: "" });
        renderPresets();
        saveData();
    }

    function delP(id) {
        presets = presets.filter(p => p.id !== id);
        renderPresets();
        saveData();
    }

    function updateP(id, key, val) {
        const t = presets.find(p => p.id === id);
        if(t) t[key] = val;
        saveData();
    }

    // == 핵심 기능: 실행 ==
    async function startRun() {
        if(!imgBase64) return alert("이미지가 없습니다.");
        const key = document.getElementById("apiKey").value;
        if(!key) return alert("API Key가 없습니다.");

        isRun = true;
        stopFlag = false;
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
        document.getElementById("resultGrid").innerHTML = ""; 
        results = {};

        const mode = document.getElementById("apiSelect").value;
        
        for(let i=0; i<presets.length; i++) {
            if(stopFlag) break;

            const p = presets[i];
            log(`[${i+1}/${presets.length}] '${p.name}' 생성 요청 중...`);
            
            try {
                // 생성 요청
                const finalImg = await callApi(mode, key, p);
                
                // 성공 시
                if(finalImg) {
                    results[p.id] = finalImg;
                    addCard(p, finalImg);
                }
            } catch(e) {
                console.error(e);
                log(`오류 (${p.name}): ${e.message}`);
                // 오류 나도 계속 할지 여부는 선택이지만 여기선 로그 찍고 진행
            }

            // 딜레이 12초 (마지막 아닐 때만)
            if(i < presets.length - 1 && !stopFlag) {
                for(let t=12; t>0; t--) {
                    if(stopFlag) break;
                    log(`대기 중... ${t}초 (다음: ${presets[i+1].name})`);
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        isRun = false;
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        log(stopFlag ? "중단됨" : "완료되었습니다.");
    }

    function stopRun() {
        if(isRun) stopFlag = true;
    }

    // == API 호출부 (중요) ==
    async function callApi(mode, key, preset) {
        const useProxy = document.getElementById("proxyMode").checked;
        const base = document.getElementById("basePrompt").value; // 기본 태그
        
        // NovelAI
        if(mode === "novelai") {
            const rawBody = imgBase64.split(",")[1]; // 헤더 제거
            const prompt = `${base}, ${preset.tag}`; 

            const bodyData = {
                input: prompt,
                model: "nai-diffusion-3",
                action: "img2img",
                parameters: {
                    image: rawBody,
                    strength: 0.7,
                    noise: 0.1,
                    scale: 6, // config
                    sampler: "k_euler_ancestral",
                    steps: 28,
                    width: 832, height: 1216,
                    sm: true, sm_dyn: true
                }
            };

            // 여기가 핵심: 일반 url과 우회 url 스위칭
            let url = "https://api.novelai.net/ai/generate-image";
            if(useProxy) {
                // corsproxy.io 등 공개 프록시를 통해 요청을 우회시킴
                url = "https://corsproxy.io/?" + encodeURIComponent(url);
            }

            const res = await fetch(url, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + key,
                    "Content-Type": "application/json",
                    // 우회 모드 시 일부 헤더 필요 없음
                },
                body: JSON.stringify(bodyData)
            });

            if(!res.ok) throw new Error("API 오류: " + res.status);

            // NAI는 ZIP 바이너리를 줌 -> JSZip으로 풀기
            const blob = await res.blob();
            const z = await JSZip.loadAsync(blob);
            const fname = Object.keys(z.files)[0]; // 첫 파일
            const b64 = await z.files[fname].async("base64");
            return "data:image/png;base64," + b64;
        }
        
        // Nano Banana (가상) - 영어 문장 만들기
        else if (mode === "nanobanana") {
            const prompt = `(English) Change original style to ${preset.tag} keep composition.`;
            // 예시 로직이므로 실제 API가 있으면 여기서 fetch
            // 가짜로 잠시 대기했다가 원본 돌려줌
            await new Promise(r => setTimeout(r, 1000));
            // 만약 실제라면: return base64Result;
            return imgBase64; 
        }
    }

    async function reGen(id) {
        if(isRun) return alert("일괄 생성 중엔 불가");
        const p = presets.find(x => x.id == id);
        const key = document.getElementById("apiKey").value;
        const mode = document.getElementById("apiSelect").value;
        
        try {
            log(`${p.name} 재생성 중...`);
            const newImg = await callApi(mode, key, p);
            if(newImg) {
                results[id] = newImg;
                document.querySelector(`#card-${id} img`).src = newImg;
            }
            log("재생성 완료");
        } catch(e) {
            alert("실패: " + e.message);
        }
    }

    // == UI 헬퍼 ==
    function log(msg) { document.getElementById("log").innerText = msg; }

    function addCard(p, src) {
        const grid = document.getElementById("resultGrid");
        const exist = document.getElementById(`card-${p.id}`);
        if(exist) {
            exist.querySelector("img").src = src;
            return;
        }

        const div = document.createElement("div");
        div.className = "card";
        div.id = `card-${p.id}`;
        div.innerHTML = `
            <img src="${src}">
            <strong>${p.name}</strong> <span style="font-size:0.8rem; color:#aaa;">${p.tag}</span><br>
            <div style="margin-top:5px; display:flex; gap:5px;">
                <button class="btn-green" onclick="saveOne('${src}', '${p.name}')" style="flex:1;">저장</button>
                <button class="btn-blue" onclick="reGen(${p.id})" style="flex:1;">↻</button>
            </div>
        `;
        grid.appendChild(div);
    }

    // == 다운로드 ==
    function saveOne(data, name) {
        saveAs(data, name + ".png");
    }

    function dlZip() {
        const z = new JSZip();
        let cnt = 0;
        Object.keys(results).forEach(id => {
            const p = presets.find(x => x.id == id);
            if(p && results[id]) {
                const pure = results[id].split(",")[1];
                z.file(p.name + ".png", pure, {base64:true});
                cnt++;
            }
        });
        if(cnt===0) return alert("다운로드할 이미지가 없어요");
        z.generateAsync({type:"blob"}).then(c => saveAs(c, "images.zip"));
    }
</script>

</body>
</html>
